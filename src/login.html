<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>TooNote</title>
	<link rel="stylesheet" href="./styles/login.css">
</head>
<body>
	<div class="banner">

	</div>
	<div class="form">
		<form id="loginForm">
			<p><input type="text" name="email" placeholder="Email" /></p>
			<p><input type="password" name="loginPassword" placeholder="Password" /></p>
			<p class="hide"><input type="text" name="registerPassword" placeholder="Password" /></p>
			<p><button type="submit">登录</button></p>
		</form>
	</div>
	<script>

		var ipc = require('ipc');
		var remote = require('remote');
		var remoteIpc = remote.require('ipc');

		var $email = document.querySelector('#loginForm input[name=email]');
		var $loginPassword = document.querySelector('#loginForm input[name=loginPassword]');
		var $registerPassword = document.querySelector('#loginForm input[name=registerPassword]');
		var $btn = document.querySelector('#loginForm button');
		var isRegister = false;

		$email.addEventListener('change',function(){
			console.log('change');
			ipc.send('login.queryUser', $email.value);
		});

		document.querySelector('#loginForm').addEventListener('submit', function(e){

			e.preventDefault();
			if(isRegister){
				ipc.send('login.doRegister', {
					email: $email.value,
					password: $registerPassword.value
				});
			}else{
				ipc.send('login.doLogin', {
					email: $email.value,
					password: $loginPassword.value
				});
			}

		});

		remoteIpc.on('loginCallback.register',function(e, isSuccess){
			console.log('after register', isSuccess);
		});

		remoteIpc.on('loginCallback.login',function(e, isSuccess){
			console.log('after login', isSuccess);
		});

		remoteIpc.on('loginCallback.queryUser',function(e, isRegistered){
			console.log('checked ', isRegistered);
			if(!isRegistered){
				$loginPassword.parentNode.classList.add('hide');
				$registerPassword.parentNode.classList.remove('hide');
				$btn.innerHTML = '注册';
				setTimeout(function(){
					$registerPassword.focus();
				}, 0);
				isRegister = true;
			}else{
				$loginPassword.parentNode.classList.remove('hide');
				$registerPassword.parentNode.classList.add('hide');
				$btn.innerHTML = '登录';
				setTimeout(function(){
					$loginPassword.focus();
				}, 0);
				isRegister = false;
			}
		});

		// 关闭窗口
		document.addEventListener('keydown',function(e){
			var ctrlOrCmd = e.metaKey || e.ctrlKey;
			// CTRL+W
			if(ctrlOrCmd && e.keyCode === 87){
				window.close();
				return;
			}
		});
	</script>
</body>
</html>
